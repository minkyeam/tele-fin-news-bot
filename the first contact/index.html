<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Little Hacker's Quest - Voice Edition</title>
  <style>
    :root {
      --bg: #0d1b1e;
      --bg-alt: #13272b;
      --panel: #1b343a;
      --accent: #7df9aa;
      --accent-2: #ffd166;
      --text: #f6fff9;
      --muted: #b4d2c1;
      --danger: #ff7a7a;
      --success: #78f0a6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      color: var(--text);
      background:
        radial-gradient(circle at 20% 15%, #1d3a40 0%, transparent 45%),
        radial-gradient(circle at 85% 85%, #193f30 0%, transparent 45%),
        linear-gradient(150deg, var(--bg) 0%, #0f252a 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: min(920px, 100%);
      border: 3px solid var(--accent);
      border-radius: 16px;
      background: rgba(16, 34, 38, 0.9);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #102328;
      border-bottom: 2px solid #1f4a45;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      color: var(--accent);
      font-size: clamp(18px, 3vw, 28px);
      letter-spacing: 0.02em;
    }

    .controls {
      display: flex;
      gap: 14px;
      align-items: center;
      color: var(--muted);
      font-size: 14px;
    }

    .main {
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    .start-screen {
      display: grid;
      gap: 16px;
      justify-items: center;
      text-align: center;
      padding: 28px 18px;
    }

    .start-btn {
      border: 0;
      border-radius: 16px;
      padding: 16px 28px;
      font-family: inherit;
      font-size: clamp(24px, 4vw, 34px);
      font-weight: 700;
      color: #082019;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 8px 0 #3dbf7e;
      transform: translateY(0);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .start-btn:active {
      transform: translateY(5px);
      box-shadow: 0 3px 0 #3dbf7e;
    }

    .level {
      border: 2px dashed #315f63;
      border-radius: 12px;
      padding: 14px;
      background: rgba(17, 36, 40, 0.8);
      min-height: 240px;
      animation: fadeIn 0.4s ease;
    }

    .level-title {
      margin: 0 0 10px;
      color: var(--accent-2);
      font-size: 18px;
    }

    pre {
      margin: 0;
      font-size: clamp(15px, 2.3vw, 20px);
      line-height: 1.35;
      color: #e8fdf2;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .desc {
      margin-top: 10px;
      color: var(--muted);
      font-size: 15px;
    }

    .hint {
      border-left: 4px solid var(--accent-2);
      background: rgba(255, 209, 102, 0.1);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 16px;
      color: #fff4d6;
    }

    .command {
      color: var(--accent);
      font-size: clamp(26px, 6vw, 42px);
      margin: 2px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .input-area {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input[type="text"] {
      flex: 1 1 260px;
      min-width: 0;
      border: 2px solid #35656a;
      border-radius: 10px;
      background: #0f2125;
      color: var(--text);
      padding: 12px;
      font-family: inherit;
      font-size: 20px;
    }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-family: inherit;
      font-size: 16px;
      cursor: pointer;
      background: #244a52;
      color: var(--text);
    }

    button:hover {
      background: #2d5a63;
    }

    .status {
      min-height: 24px;
      font-size: 16px;
      color: var(--muted);
    }

    .status.ok {
      color: var(--success);
    }

    .status.err {
      color: var(--danger);
    }

    .hidden {
      display: none;
    }

    .done {
      text-align: center;
      font-size: clamp(20px, 3.2vw, 28px);
      color: var(--success);
      padding: 22px;
      border: 2px solid #3f8b68;
      border-radius: 12px;
      background: rgba(44, 92, 74, 0.2);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <main class="app" aria-live="polite">
    <header class="header">
      <h1 class="title">Little Hacker's Quest - Voice Edition</h1>
      <div class="controls">
        <label>
          <input id="letterSoundToggle" type="checkbox" checked />
          키 입력 알파벳 읽기
        </label>
      </div>
    </header>

    <section class="main">
      <section id="startScreen" class="start-screen">
        <p>소리를 켜고 시작하면, 미션을 목소리로 안내해줘요.</p>
        <button id="startBtn" class="start-btn" type="button">시작!</button>
      </section>

      <section id="gameScreen" class="hidden">
        <article class="level" id="levelCard">
          <h2 class="level-title" id="levelTitle"></h2>
          <pre id="sceneArt"></pre>
          <p class="desc" id="sceneDesc"></p>
        </article>

        <section class="hint">
          <strong>입력할 명령어</strong>
          <p class="command" id="commandText"></p>
          <p id="spellingText"></p>
        </section>

        <section class="input-area">
          <input id="commandInput" type="text" autocomplete="off" spellcheck="false" aria-label="명령어 입력" />
          <button id="submitBtn" type="button">입력</button>
          <button id="repeatBtn" type="button">힌트 다시 듣기</button>
        </section>

        <p id="status" class="status"></p>
        <section id="doneBox" class="done hidden"></section>
      </section>
    </section>
  </main>

  <script>
    const levels = [
      {
        title: 'Lv.1 마법의 방',
        command: 'on',
        spelling: 'O, N',
        artBefore: String.raw`
  .--------------------.
  |      (어두운 방)     |
  |        ....         |
  |       ......        |
  '--------------------'
`,
        artAfter: String.raw`
  .--------------------.
  |      (밝은 방)       |
  |      \  ☀  /        |
  |       \ | /         |
  '--------------------'
`,
        descBefore: '방이 아주 어두워 보여요.',
        descAfter: '우와! 방이 환하게 밝아졌어요.',
        contextTTS: '방이 너무 어두워요. 불을 켜 주면 좋겠어요.',
        rewardTTS: '우와, 성공이야! 방이 정말 환해졌네. 아주 잘했어!'
      },
      {
        title: 'Lv.2 배고픈 강아지',
        command: 'feed',
        spelling: 'F, E, E, D',
        artBefore: String.raw`
 / \__
(    @\___
 /         O
/   (_____/
/_____/   U
`,
        artAfter: String.raw`
 / \__
(    ^\___   <3
 /         O  <3
/   (_____/
/_____/   U
`,
        descBefore: '강아지 초코가 배가 고파 보여요.',
        descAfter: '초코가 맛있게 먹고 하트를 보여줘요!',
        contextTTS: '강아지 초코가 배가 고픈가 봐요. 밥을 주면 기뻐할 거예요.',
        rewardTTS: '정답! 초코가 정말 맛있게 먹고 있어. 멍멍!'
      },
      {
        title: 'Lv.3 잠든 로봇',
        command: 'wake',
        spelling: 'W, A, K, E',
        artBefore: String.raw`
   [ -_- ]
  /|  z |\
   |____|
   /    \\
`,
        artAfter: String.raw`
   [ ^_^ ]
  /| HELLO|\
   |____|
   /    \\
`,
        descBefore: '로봇이 잠들어 있어요.',
        descAfter: '로봇이 깨어나서 인사해요!',
        contextTTS: '로봇이 잠들어 있어요. 살짝 깨워 볼까요?',
        rewardTTS: '멋져! 로봇이 눈을 뜨고 인사했어. 이제 같이 놀 수 있어!'
      }
    ];

    const ui = {
      startScreen: document.getElementById('startScreen'),
      gameScreen: document.getElementById('gameScreen'),
      startBtn: document.getElementById('startBtn'),
      levelTitle: document.getElementById('levelTitle'),
      sceneArt: document.getElementById('sceneArt'),
      sceneDesc: document.getElementById('sceneDesc'),
      commandText: document.getElementById('commandText'),
      spellingText: document.getElementById('spellingText'),
      commandInput: document.getElementById('commandInput'),
      submitBtn: document.getElementById('submitBtn'),
      repeatBtn: document.getElementById('repeatBtn'),
      status: document.getElementById('status'),
      doneBox: document.getElementById('doneBox'),
      letterSoundToggle: document.getElementById('letterSoundToggle')
    };

    let currentLevel = 0;
    let gameStarted = false;
    let koreanVoice = null;
    let lastLetterSpokenAt = 0;

    const letterKo = {
      A: '에이',
      B: '비',
      C: '씨',
      D: '디',
      E: '이',
      F: '에프',
      G: '지',
      H: '에이치',
      I: '아이',
      J: '제이',
      K: '케이',
      L: '엘',
      M: '엠',
      N: '엔',
      O: '오',
      P: '피',
      Q: '큐',
      R: '알',
      S: '에스',
      T: '티',
      U: '유',
      V: '브이',
      W: '더블유',
      X: '엑스',
      Y: '와이',
      Z: '지'
    };

    function commandToSpellingKo(command) {
      return command
        .toUpperCase()
        .split('')
        .map(letter => letterKo[letter] || letter)
        .join(', ');
    }

    function buildIntroTTS(level) {
      const commandUpper = level.command.toUpperCase();
      const spellingKo = commandToSpellingKo(level.command);
      return `${level.contextTTS} 정답 명령어는 ${commandUpper}. 천천히 눌러보자. ${spellingKo}.`;
    }

    function pickKoreanVoice() {
      const voices = speechSynthesis.getVoices();
      koreanVoice = voices.find(v => /ko-KR/i.test(v.lang) && /google|enhanced|premium/i.test(v.name))
        || voices.find(v => /ko-KR/i.test(v.lang))
        || voices.find(v => /korean|한국/i.test(v.name))
        || null;
    }

    function speak(text, options = {}) {
      if (!gameStarted || !('speechSynthesis' in window)) return;
      const interrupt = options.interrupt ?? true;
      if (interrupt) speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ko-KR';
      utter.rate = options.rate ?? 0.9;
      utter.pitch = options.pitch ?? 1.0;
      if (koreanVoice) utter.voice = koreanVoice;
      speechSynthesis.speak(utter);
    }

    function setStatus(text, type = '') {
      ui.status.textContent = text;
      ui.status.className = `status ${type}`.trim();
    }

    function renderLevel() {
      const level = levels[currentLevel];
      ui.levelTitle.textContent = level.title;
      ui.sceneArt.textContent = level.artBefore;
      ui.sceneDesc.textContent = level.descBefore;
      ui.commandText.textContent = level.command.toUpperCase();
      ui.spellingText.textContent = `철자 힌트: ${level.spelling} (${commandToSpellingKo(level.command)})`;
      ui.commandInput.value = '';
      ui.commandInput.focus();
      setStatus('목소리를 듣고 알파벳을 찾아 입력해보세요.');
      speak(buildIntroTTS(level), { rate: 0.88 });
    }

    function completeLevel() {
      const level = levels[currentLevel];
      ui.sceneArt.textContent = level.artAfter;
      ui.sceneDesc.textContent = level.descAfter;
      setStatus('성공! 다음 레벨로 이동할게요.', 'ok');
      speak(level.rewardTTS, { rate: 0.9 });

      setTimeout(() => {
        currentLevel += 1;
        if (currentLevel >= levels.length) {
          ui.doneBox.textContent = '모든 미션 완료! 너는 오늘의 꼬마 해커야!';
          ui.doneBox.classList.remove('hidden');
          setStatus('끝! 다시 하려면 페이지를 새로고침하세요.', 'ok');
          speak('모든 미션을 성공했어요! 오늘의 꼬마 해커로 임명!', { rate: 0.9 });
          ui.submitBtn.disabled = true;
          ui.repeatBtn.disabled = true;
          ui.commandInput.disabled = true;
          return;
        }
        renderLevel();
      }, 1800);
    }

    function handleSubmit() {
      if (currentLevel >= levels.length) return;
      const level = levels[currentLevel];
      const answer = ui.commandInput.value.trim().toLowerCase();

      if (answer === level.command) {
        completeLevel();
      } else {
        setStatus('조금 달라요. 힌트를 다시 들어볼까요?', 'err');
        speak(`괜찮아, 다시 해보자. 정답은 ${level.command.toUpperCase()}. ${commandToSpellingKo(level.command)}.`, { rate: 0.88 });
      }
    }

    function handleLetterSound(event) {
      if (!ui.letterSoundToggle.checked || !gameStarted) return;
      if (event.key.length !== 1) return;
      if (!/[a-z]/i.test(event.key)) return;
      const now = Date.now();
      if (now - lastLetterSpokenAt < 80) return;
      lastLetterSpokenAt = now;
      const letter = event.key.toUpperCase();
      speak(letterKo[letter] || letter, { rate: 0.82, pitch: 1.04, interrupt: false });
    }

    ui.startBtn.addEventListener('click', () => {
      gameStarted = true;
      pickKoreanVoice();
      ui.startScreen.classList.add('hidden');
      ui.gameScreen.classList.remove('hidden');
      renderLevel();
    });

    ui.submitBtn.addEventListener('click', handleSubmit);
    ui.repeatBtn.addEventListener('click', () => {
      if (currentLevel < levels.length) {
        speak(buildIntroTTS(levels[currentLevel]), { rate: 0.88 });
      }
    });

    ui.commandInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        handleSubmit();
      } else {
        handleLetterSound(event);
      }
    });

    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = pickKoreanVoice;
      pickKoreanVoice();
    } else {
      setStatus('이 브라우저는 음성 안내를 지원하지 않아요.');
    }
  </script>
</body>
</html>
